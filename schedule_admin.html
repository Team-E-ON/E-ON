<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="utf-8" />
    <title>ì¼ì •ëª©ë¡ - Admin</title>
    <link href="schedule.css" rel="stylesheet" />
</head>

<body>
<div class="main-bg">
    <nav class="mypage-nav">
        <div class="mypage-logo">E: ON</div>
        <div class="mypage-menu">
            <a href="Home.html">í™ˆ</a>
            <a href="schedule_user.html">ì¼ì •ëª©ë¡</a>
            <a class="active" href="mypage.html">ë§ˆì´í˜ì´ì§€</a>
            <div class="mypage-menu-right">
                <span>Team 06</span>
                <span>|</span>
                <a href="Home.html">ë¡œê·¸ì•„ì›ƒ</a>
            </div>
        </div>
    </nav>

    <div class="main-content" style="display: none;">
        <div class="schedule-list">

            <div id="group-container">
                <!-- ì„œë²„ì—ì„œ ë°›ì•„ì˜¬ ê·¸ë£¹ HTMLì´ ì—¬ê¸°ì— ì‚½ì…ë¨ -->
            </div>

            <div id="event-container">
                <!-- ì„ íƒëœ ê·¸ë£¹ì˜ ì¼ì •ì´ ì—¬ê¸°ì— ì¶œë ¥ë¨ -->
            </div>

        </div>
    </div>

    <div class="main-content">
        <div class="schedule-list">

            <h1>í•™ê³¼ ì¼ì •</h1>
            <div class="department-events">
                {{departmentGroups}}
            </div>

            <h1>ë™ì•„ë¦¬ ì¼ì •</h1>
            <div class="club-events">
                {{clubGroups}}
            </div>

            <div class="schedule-group" data-group="ì‚¬ì´ë²„ë³´ì•ˆí•™ê³¼">
                <div class="group-title">ì‚¬ì´ë²„ë³´ì•ˆí•™ê³¼ ì¼ì • <button class="add-btn">ì¶”ê°€ +</button></div>
                <div class="schedule-item">
                    <div class="item-left"><span class="item-title">MAYt-day</span><span
                            class="item-date">2025.06.05</span>
                    </div><span class="item-actions"><button class="edit-btn">âœ</button><button
                        class="delete-btn">ğŸ—‘</button></span>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- ìˆ˜ì • ëª¨ë‹¬ -->
<div class="edit-modal-bg" id="edit-modal-bg">
    <div class="edit-modal">
        <h3>ì¼ì • ìˆ˜ì •</h3>
        <input type="text" id="edit-title" placeholder="ì œëª©">
        <input type="date" id="edit-date">
        <textarea id="edit-content" placeholder="ì„¤ëª…"></textarea>
        <button id="edit-save">ì €ì¥</button>
        <button class="modal-close-btn" onclick="closeModal('edit-modal-bg')">ë‹«ê¸°</button>
    </div>
</div>

<!-- ì¶”ê°€ ëª¨ë‹¬ -->
<div class="add-modal-bg" id="add-modal-bg">
    <div class="add-modal">
        <h3>ì¼ì • ì¶”ê°€</h3>
        <select id="group-type-select">
            <option value="department">í•™ê³¼</option>
            <option value="club">ë™ì•„ë¦¬</option>
        </select>
        <select id="group-select">
            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
        </select>
        <input type="text" id="add-title" placeholder="ì œëª©">
        <input type="date" id="add-date">
        <input type="time" id="add-time">
        <textarea id="add-content" placeholder="ì„¤ëª…"></textarea>
        <button id="add-save">ì¶”ê°€</button>
        <button class="modal-close-btn" onclick="closeModal('add-modal-bg')">ë‹«ê¸°</button>
    </div>
</div>

<!-- ì˜¤ë¥¸ìª½ í•˜ë‹¨ í”Œë¡œíŒ… ë²„íŠ¼ -->
<button id="open-add-modal-btn" class="floating-add-btn">ì¼ì • ì¶”ê°€ +</button>

<script>
    function closeModal(id) {
        document.getElementById(id).classList.remove('active');
    }

    // ê·¸ë£¹ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ë° ë Œë”ë§
    async function fetchGroups() {
        try {
            const res = await fetch('/scheduleadmin/groups');
            if (!res.ok) throw new Error('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜');
            const html = await res.text();
            document.getElementById('group-container').innerHTML = html;

            // ìƒˆë¡œ ë Œë”ë§ëœ ê·¸ë£¹ ìš”ì†Œì— í´ë¦­ ì´ë²¤íŠ¸ ë°”ì¸ë”©
            document.querySelectorAll('.group-item').forEach(item => {
                item.addEventListener('click', () => {
                    const type = item.dataset.type;
                    const group = item.dataset.group;
                    fetchEvents(type, group);
                });
            });

            // selectì—ë„ ì±„ì›Œì£¼ê¸°
            extractGroupsToSelect();
        } catch (e) {
            console.error(e);
            document.getElementById('group-container').innerHTML = "<p>ê·¸ë£¹ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>";
        }
    }

    // ê·¸ë£¹ ë¦¬ìŠ¤íŠ¸ë¥¼ select ìš”ì†Œì— ì±„ìš°ê¸°
    function extractGroupsToSelect() {
        const deptList = Array.from(document.querySelectorAll('[data-type="department"]')).map(e => e.dataset.group);
        const clubList = Array.from(document.querySelectorAll('[data-type="club"]')).map(e => e.dataset.group);

        document.getElementById('group-type-select').addEventListener('change', e => {
            fillGroupSelect(e.target.value, deptList, clubList);
        });

        fillGroupSelect(document.getElementById('group-type-select').value, deptList, clubList);
    }

    function fillGroupSelect(type, departments, clubs) {
        const select = document.getElementById('group-select');
        select.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
        const list = type === 'department' ? departments : clubs;
        list.forEach(name => {
            const opt = document.createElement('option');
            opt.value = name;
            opt.textContent = name;
            select.appendChild(opt);
        });
    }

    async function fetchEvents(type, group) {
        try {
            const res = await fetch(`/scheduleadmin/events?type=${type}&group=${encodeURIComponent(group)}`);
            if (!res.ok) throw new Error('ì¼ì • ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');
            const html = await res.text();
            document.getElementById('event-container').innerHTML = html;
        } catch (e) {
            console.error(e);
            document.getElementById('event-container').innerHTML = '<p>ì¼ì •ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>';
        }
    }

    document.getElementById('open-add-modal-btn').addEventListener('click', () => {
        document.getElementById('add-modal-bg').classList.add('active');
        extractGroupsToSelect();  // select ê°±ì‹ 
        document.getElementById('group-select').value = '';
        document.getElementById('add-title').value = '';
        document.getElementById('add-date').value = '';
        document.getElementById('add-content').value = '';
    });

    document.getElementById('add-save').addEventListener('click', async () => {
        const type = document.getElementById('group-type-select').value;
        const group = document.getElementById('group-select').value;
        const title = document.getElementById('add-title').value.trim();
        const date = document.getElementById('add-date').value;
        const time = document.getElementById('add-time').value;
        const content = document.getElementById('add-content').value.trim();
        const datetime = date + " " + time;  // "2025-05-20 14:30" í˜•íƒœ

        if (!group || !title || !date) {
            alert('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
            return;
        }

        const data = new URLSearchParams();
        data.append("type", type);
        data.append("group", group);
        data.append("title", title);
        data.append("date", datetime);
        data.append("content", content);

        try {
            const res = await fetch('/scheduleadmin/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: data
            });

            if (res.ok) {
                alert('ì¼ì •ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                location.reload();
            } else {
                alert('ì¶”ê°€ ì‹¤íŒ¨!');
            }
        } catch (e) {
            console.error(e);
            alert('ì„œë²„ ì˜¤ë¥˜ ë°œìƒ');
        }

        document.getElementById('add-modal-bg').classList.remove('active');
    });

    fetchGroups();  // ì´ˆê¸° ê·¸ë£¹ ë¶ˆëŸ¬ì˜¤ê¸°

    document.addEventListener("DOMContentLoaded", () => {
        // ëª¨ë“  ì‚­ì œ ë²„íŠ¼ì— í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
        document.querySelectorAll(".delete-btn").forEach(button => {
            button.addEventListener("click", async (e) => {
                if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

                // í˜„ì¬ ë²„íŠ¼ì—ì„œ ê°€ì¥ ê°€ê¹Œìš´ .schedule-itemì„ ì°¾ê³ , ê·¸ ì•ˆì˜ .event-id ê°’ì„ ì½ìŒ
                const scheduleItem = e.target.closest(".schedule-item");
                const idElem = scheduleItem.querySelector(".event-id");
                if (!idElem) {
                    alert("ì‚­ì œí•  ì´ë²¤íŠ¸ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    return;
                }

                const eventId = idElem.textContent.trim();

                try {
                    // POST ìš”ì²­ ë³´ë‚´ê¸° (fetch API)
                    const response = await fetch("/scheduleadmin/deletee", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/x-www-form-urlencoded"
                        },
                        body: `id=${encodeURIComponent(eventId)}`
                    });

                    if (response.ok) {
                        // ì‚­ì œ ì„±ê³µ ì‹œ í™”ë©´ì—ì„œ í•´ë‹¹ ì¼ì • í•­ëª© ì œê±°
                        scheduleItem.remove();
                        alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    } else {
                        alert("ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                    }
                } catch (error) {
                    alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                    console.error(error);
                }
            });
        });
    });

    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('edit-btn')) {
            const item = e.target.closest('.schedule-item');
            const id = item.querySelector('.event-id').textContent.trim(); // id ê°€ì ¸ì˜¤ê¸°
            const title = item.querySelector('.item-title').textContent;
            const date = item.querySelector('.item-date').textContent;
            const content = item.querySelector('.item-content').textContent;

            // ëª¨ë‹¬ ê°’ ì±„ìš°ê¸° (ê¸°ì¡´ ì½”ë“œ ìœ ì§€)
            document.getElementById('edit-title').value = title;
            document.getElementById('edit-date').value = date.split(' ')[0];
            document.getElementById('edit-content').value = content;

            // ëª¨ë‹¬ ì—´ê¸°
            document.getElementById('edit-modal-bg').classList.add('active');

            const saveBtn = document.getElementById('edit-save');
            saveBtn.onclick = async () => {
                const newTitle = document.getElementById('edit-title').value.trim();
                const newDate = document.getElementById('edit-date').value;
                const newContent = document.getElementById('edit-content').value.trim();

                if (!newTitle || !newDate) {
                    alert('ì œëª©ê³¼ ë‚ ì§œëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.');
                    return;
                }

                const params = new URLSearchParams({
                    id: id,  // id ì¶”ê°€
                    newTitle,
                    newDate,
                    newContent
                });

                try {
                    const res = await fetch('/scheduleadmin/edit', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: params.toString()
                    });

                    if (res.ok) {
                        alert('ìˆ˜ì • ì™„ë£Œ');
                        location.reload();
                    } else {
                        alert('ìˆ˜ì • ì‹¤íŒ¨');
                    }
                } catch (err) {
                    alert('ì„œë²„ ì˜¤ë¥˜');
                }
                closeModal('edit-modal-bg');
            };
        }
    });
</script>
</body>

</html>